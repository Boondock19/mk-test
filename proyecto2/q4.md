# Reporte de dinero recaudado por asiento en un mes de vuelos

```
SELECT
	f.aircraft_code,
	s.seat_no,
	SUM(tf.amount) total_amount
FROM 
	seats s
JOIN 
	flights f ON f.aircraft_code = s.aircraft_code
JOIN 
	ticket_flights tf ON tf.flight_id = f.flight_id
WHERE DATE(f.scheduled_departure) 
	BETWEEN '2017-01-26' AND '2017-02-26'
GROUP BY f.aircraft_code, s.seat_no
```

# PLAN ORIGINAL

[
  {
    "Plan": {
      "Node Type": "Aggregate",
      "Strategy": "Sorted",
      "Partial Mode": "Finalize",
      "Parallel Aware": false,
      "Async Capable": false,
      "Startup Cost": 152082.30,
      "Total Cost": 153062.75,
      "Plan Rows": 3688,
      "Plan Width": 39,
      "Actual Startup Time": 31142.181,
      "Actual Total Time": 31152.545,
      "Actual Rows": 1199,
      "Actual Loops": 1,
      "Group Key": ["f.aircraft_code", "s.seat_no"],
      "Plans": [
        {
          "Node Type": "Gather Merge",
          "Parent Relationship": "Outer",
          "Parallel Aware": false,
          "Async Capable": false,
          "Startup Cost": 152082.30,
          "Total Cost": 152942.89,
          "Plan Rows": 7376,
          "Plan Width": 39,
          "Actual Startup Time": 31142.164,
          "Actual Total Time": 31151.591,
          "Actual Rows": 3597,
          "Actual Loops": 1,
          "Workers Planned": 2,
          "Workers Launched": 2,
          "Plans": [
            {
              "Node Type": "Sort",
              "Parent Relationship": "Outer",
              "Parallel Aware": false,
              "Async Capable": false,
              "Startup Cost": 151082.27,
              "Total Cost": 151091.49,
              "Plan Rows": 3688,
              "Plan Width": 39,
              "Actual Startup Time": 30876.863,
              "Actual Total Time": 30876.951,
              "Actual Rows": 1199,
              "Actual Loops": 3,
              "Sort Key": ["f.aircraft_code", "s.seat_no"],
              "Sort Method": "quicksort",
              "Sort Space Used": 217,
              "Sort Space Type": "Memory",
              "Workers": [
                {
                  "Worker Number": 0,
                  "Sort Method": "quicksort",
                  "Sort Space Used": 217,
                  "Sort Space Type": "Memory"
                },
                {
                  "Worker Number": 1,
                  "Sort Method": "quicksort",
                  "Sort Space Used": 217,
                  "Sort Space Type": "Memory"
                }
              ],
              "Plans": [
                {
                  "Node Type": "Aggregate",
                  "Strategy": "Hashed",
                  "Partial Mode": "Partial",
                  "Parent Relationship": "Outer",
                  "Parallel Aware": false,
                  "Async Capable": false,
                  "Startup Cost": 150817.68,
                  "Total Cost": 150863.78,
                  "Plan Rows": 3688,
                  "Plan Width": 39,
                  "Actual Startup Time": 30875.491,
                  "Actual Total Time": 30875.854,
                  "Actual Rows": 1199,
                  "Actual Loops": 3,
                  "Group Key": ["f.aircraft_code", "s.seat_no"],
                  "Planned Partitions": 0,
                  "HashAgg Batches": 1,
                  "Peak Memory Usage": 721,
                  "Disk Usage": 0,
                  "Workers": [
                    {
                      "Worker Number": 0,
                      "HashAgg Batches": 1,
                      "Peak Memory Usage": 721,
                      "Disk Usage": 0
                    },
                    {
                      "Worker Number": 1,
                      "HashAgg Batches": 1,
                      "Peak Memory Usage": 721,
                      "Disk Usage": 0
                    }
                  ],
                  "Plans": [
                    {
                      "Node Type": "Merge Join",
                      "Parent Relationship": "Outer",
                      "Parallel Aware": false,
                      "Async Capable": false,
                      "Join Type": "Inner",
                      "Startup Cost": 120559.27,
                      "Total Cost": 140760.56,
                      "Plan Rows": 1340950,
                      "Plan Width": 13,
                      "Actual Startup Time": 1411.384,
                      "Actual Total Time": 15106.906,
                      "Actual Rows": 36779366,
                      "Actual Loops": 3,
                      "Inner Unique": false,
                      "Merge Cond": "(f.aircraft_code = s.aircraft_code)",
                      "Workers": [
                      ],
                      "Plans": [
                        {
                          "Node Type": "Sort",
                          "Parent Relationship": "Outer",
                          "Parallel Aware": false,
                          "Async Capable": false,
                          "Startup Cost": 120468.34,
                          "Total Cost": 120512.03,
                          "Plan Rows": 17477,
                          "Plan Width": 10,
                          "Actual Startup Time": 1411.104,
                          "Actual Total Time": 1495.238,
                          "Actual Rows": 233586,
                          "Actual Loops": 3,
                          "Sort Key": ["f.aircraft_code"],
                          "Sort Method": "external merge",
                          "Sort Space Used": 4704,
                          "Sort Space Type": "Disk",
                          "Workers": [
                            {
                              "Worker Number": 0,
                              "Sort Method": "external merge",
                              "Sort Space Used": 4648,
                              "Sort Space Type": "Disk"
                            },
                            {
                              "Worker Number": 1,
                              "Sort Method": "external merge",
                              "Sort Space Used": 4632,
                              "Sort Space Type": "Disk"
                            }
                          ],
                          "Plans": [
                            {
                              "Node Type": "Hash Join",
                              "Parent Relationship": "Outer",
                              "Parallel Aware": true,
                              "Async Capable": false,
                              "Join Type": "Inner",
                              "Startup Cost": 5159.75,
                              "Total Cost": 119236.81,
                              "Plan Rows": 17477,
                              "Plan Width": 10,
                              "Actual Startup Time": 69.191,
                              "Actual Total Time": 1311.478,
                              "Actual Rows": 233586,
                              "Actual Loops": 3,
                              "Inner Unique": true,
                              "Hash Cond": "(tf.flight_id = f.flight_id)",
                              "Workers": [
                              ],
                              "Plans": [
                                {
                                  "Node Type": "Seq Scan",
                                  "Parent Relationship": "Outer",
                                  "Parallel Aware": true,
                                  "Async Capable": false,
                                  "Relation Name": "ticket_flights",
                                  "Alias": "tf",
                                  "Startup Cost": 0.00,
                                  "Total Cost": 104898.45,
                                  "Plan Rows": 3496545,
                                  "Plan Width": 10,
                                  "Actual Startup Time": 0.184,
                                  "Actual Total Time": 526.996,
                                  "Actual Rows": 2797284,
                                  "Actual Loops": 3,
                                  "Workers": [
                                  ]
                                },
                                {
                                  "Node Type": "Hash",
                                  "Parent Relationship": "Inner",
                                  "Parallel Aware": true,
                                  "Async Capable": false,
                                  "Startup Cost": 5151.85,
                                  "Total Cost": 5151.85,
                                  "Plan Rows": 632,
                                  "Plan Width": 8,
                                  "Actual Startup Time": 63.129,
                                  "Actual Total Time": 63.130,
                                  "Actual Rows": 5787,
                                  "Actual Loops": 3,
                                  "Hash Buckets": 16384,
                                  "Original Hash Buckets": 2048,
                                  "Hash Batches": 1,
                                  "Original Hash Batches": 1,
                                  "Peak Memory Usage": 976,
                                  "Workers": [
                                  ],
                                  "Plans": [
                                    {
                                      "Node Type": "Seq Scan",
                                      "Parent Relationship": "Outer",
                                      "Parallel Aware": true,
                                      "Async Capable": false,
                                      "Relation Name": "flights",
                                      "Alias": "f",
                                      "Startup Cost": 0.00,
                                      "Total Cost": 5151.85,
                                      "Plan Rows": 632,
                                      "Plan Width": 8,
                                      "Actual Startup Time": 21.809,
                                      "Actual Total Time": 45.468,
                                      "Actual Rows": 5787,
                                      "Actual Loops": 3,
                                      "Filter": "((date(scheduled_departure) >= '2017-01-26'::date) AND (date(scheduled_departure) <= '2017-02-26'::date))",
                                      "Rows Removed by Filter": 65836,
                                      "Workers": [
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "Node Type": "Sort",
                          "Parent Relationship": "Inner",
                          "Parallel Aware": false,
                          "Async Capable": false,
                          "Startup Cost": 90.93,
                          "Total Cost": 94.28,
                          "Plan Rows": 1339,
                          "Plan Width": 7,
                          "Actual Startup Time": 0.254,
                          "Actual Total Time": 3571.984,
                          "Actual Rows": 36697953,
                          "Actual Loops": 3,
                          "Sort Key": ["s.aircraft_code"],
                          "Sort Method": "quicksort",
                          "Sort Space Used": 111,
                          "Sort Space Type": "Memory",
                          "Workers": [
                            {
                              "Worker Number": 0,
                              "Sort Method": "quicksort",
                              "Sort Space Used": 111,
                              "Sort Space Type": "Memory"
                            },
                            {
                              "Worker Number": 1,
                              "Sort Method": "quicksort",
                              "Sort Space Used": 111,
                              "Sort Space Type": "Memory"
                            }
                          ],
                          "Plans": [
                            {
                              "Node Type": "Seq Scan",
                              "Parent Relationship": "Outer",
                              "Parallel Aware": false,
                              "Async Capable": false,
                              "Relation Name": "seats",
                              "Alias": "s",
                              "Startup Cost": 0.00,
                              "Total Cost": 21.39,
                              "Plan Rows": 1339,
                              "Plan Width": 7,
                              "Actual Startup Time": 0.021,
                              "Actual Total Time": 0.100,
                              "Actual Rows": 1339,
                              "Actual Loops": 3,
                              "Workers": [
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    "Planning Time": 0.347,
    "Triggers": [
    ],
    "JIT": {
      "Functions": 84,
      "Options": {
        "Inlining": false,
        "Optimization": false,
        "Expressions": true,
        "Deforming": true
      },
      "Timing": {
        "Generation": 13.986,
        "Inlining": 0.000,
        "Optimization": 1.150,
        "Emission": 64.362,
        "Total": 79.498
      }
    },
    "Execution Time": 31153.987
  }
]

# INDICES

## P1: B+ index (scheduled_departure, aircraft_code) en la tabla flights
###    B+ index (aircraft_code) en la tabla seats


GroupAggregate  (cost=1458326.30..1530704.82 rows=3688 width=39) (actual time=4692.427..28238.105 rows=1199 loops=1)
  Group Key: f.aircraft_code, s.seat_no
  ->  Merge Join  (cost=1458326.30..1506570.25 rows=3211796 width=13) (actual time=4684.695..20057.144 rows=110338099 loops=1)
        Merge Cond: (s.aircraft_code = f.aircraft_code)
        ->  Index Only Scan using seats_pkey on seats s  (cost=0.28..64.60 rows=1339 width=7) (actual time=0.012..2.717 rows=1339 loops=1)
              Heap Fetches: 1339
        ->  Sort  (cost=1458326.03..1458430.89 rows=41945 width=10) (actual time=4595.372..10441.108 rows=110338003 loops=1)
              Sort Key: f.aircraft_code
              Sort Method: external sort  Disk: 16704kB
              ->  Merge Join  (cost=1412730.47..1455105.45 rows=41945 width=10) (actual time=3588.373..4446.594 rows=700759 loops=1)
                    Merge Cond: (f.flight_id = tf.flight_id)
                    ->  Sort  (cost=6975.41..6978.09 rows=1074 width=8) (actual time=27.656..28.366 rows=17360 loops=1)
                          Sort Key: f.flight_id
                          Sort Method: quicksort  Memory: 1582kB
                          ->  Seq Scan on flights f  (cost=0.00..6921.34 rows=1074 width=8) (actual time=0.064..26.442 rows=17360 loops=1)
                                Filter: ((date(scheduled_departure) >= '2017-01-26'::date) AND (date(scheduled_departure) <= '2017-02-26'::date))
                                Rows Removed by Filter: 197507
                    ->  Sort  (cost=1405750.87..1426730.14 rows=8391708 width=10) (actual time=3560.642..4067.894 rows=8391457 loops=1)
                          Sort Key: tf.flight_id
                          Sort Method: external sort  Disk: 213568kB
                          ->  Seq Scan on ticket_flights tf  (cost=0.00..153850.08 rows=8391708 width=10) (actual time=0.021..575.513 rows=8391852 loops=1)
Planning Time: 0.540 ms
JIT:
  Functions: 21
  Options: Inlining true, Optimization true, Expressions true, Deforming true
  Timing: Generation 0.719 ms, Inlining 5.273 ms, Optimization 51.524 ms, Emission 32.540 ms, Total 90.057 ms
Execution Time: 28256.993 ms


## P2: B+ index (flight_id) en la tabla ticket_flights
GroupAggregate  (cost=252988.31..325154.54 rows=3688 width=39) (actual time=1337.125..27304.809 rows=1199 loops=1)
  Group Key: f.aircraft_code, s.seat_no
  ->  Merge Join  (cost=252988.31..301091.02 rows=3202323 width=13) (actual time=1328.618..17558.948 rows=110338099 loops=1)
        Merge Cond: (s.aircraft_code = f.aircraft_code)
        ->  Index Only Scan using seats_pkey on seats s  (cost=0.28..64.60 rows=1339 width=7) (actual time=0.012..5.062 rows=1339 loops=1)
              Heap Fetches: 1339
        ->  Sort  (cost=252988.03..253092.90 rows=41947 width=10) (actual time=1322.276..7212.752 rows=110338003 loops=1)
              Sort Key: f.aircraft_code
              Sort Method: external sort  Disk: 16704kB
              ->  Nested Loop  (cost=0.43..249767.28 rows=41947 width=10) (actual time=0.052..1161.461 rows=700759 loops=1)
                    ->  Seq Scan on flights f  (cost=0.00..6921.34 rows=1074 width=8) (actual time=0.033..34.141 rows=17360 loops=1)
                          Filter: ((date(scheduled_departure) >= '2017-01-26'::date) AND (date(scheduled_departure) <= '2017-02-26'::date))
                          Rows Removed by Filter: 197507
                    ->  Index Scan using q4_tf_fid on ticket_flights tf  (cost=0.43..225.10 rows=101 width=10) (actual time=0.002..0.061 rows=40 loops=17360)
                          Index Cond: (flight_id = f.flight_id)
Planning Time: 0.972 ms
JIT:
  Functions: 16
  Options: Inlining false, Optimization false, Expressions true, Deforming true
  Timing: Generation 0.626 ms, Inlining 0.000 ms, Optimization 0.373 ms, Emission 5.952 ms, Total 6.951 ms
Execution Time: 27307.513 ms

##	P3: B+ index (flight_id) en la tabla ticket_flights
###     B+ index (aircraft_code) en la tabla flights
GroupAggregate  (cost=252988.31..325154.54 rows=3688 width=39) (actual time=1337.125..27304.809 rows=1199 loops=1)
  Group Key: f.aircraft_code, s.seat_no
  ->  Merge Join  (cost=252988.31..301091.02 rows=3202323 width=13) (actual time=1328.618..17558.948 rows=110338099 loops=1)
        Merge Cond: (s.aircraft_code = f.aircraft_code)
        ->  Index Only Scan using seats_pkey on seats s  (cost=0.28..64.60 rows=1339 width=7) (actual time=0.012..5.062 rows=1339 loops=1)
              Heap Fetches: 1339
        ->  Sort  (cost=252988.03..253092.90 rows=41947 width=10) (actual time=1322.276..7212.752 rows=110338003 loops=1)
              Sort Key: f.aircraft_code
              Sort Method: external sort  Disk: 16704kB
              ->  Nested Loop  (cost=0.43..249767.28 rows=41947 width=10) (actual time=0.052..1161.461 rows=700759 loops=1)
                    ->  Seq Scan on flights f  (cost=0.00..6921.34 rows=1074 width=8) (actual time=0.033..34.141 rows=17360 loops=1)
                          Filter: ((date(scheduled_departure) >= '2017-01-26'::date) AND (date(scheduled_departure) <= '2017-02-26'::date))
                          Rows Removed by Filter: 197507
                    ->  Index Scan using q4_tf_fid on ticket_flights tf  (cost=0.43..225.10 rows=101 width=10) (actual time=0.002..0.061 rows=40 loops=17360)
                          Index Cond: (flight_id = f.flight_id)
Planning Time: 0.972 ms
JIT:
  Functions: 16
  Options: Inlining false, Optimization false, Expressions true, Deforming true
  Timing: Generation 0.626 ms, Inlining 0.000 ms, Optimization 0.373 ms, Emission 5.952 ms, Total 6.951 ms
Execution Time: 27307.513 ms


## P4: B+ index (flight_id) en la tabla ticket_flights
###    B+ index (aircraft_code) en la tabla seats
GroupAggregate  (cost=259788.95..332708.56 rows=3688 width=39) (actual time=1367.173..27412.345 rows=1199 loops=1)
  Group Key: f.aircraft_code, s.seat_no
  ->  Merge Join  (cost=259788.95..308394.00 rows=3235795 width=13) (actual time=1358.622..17542.332 rows=110338099 loops=1)
        Merge Cond: (s.aircraft_code = f.aircraft_code)
        ->  Index Only Scan using seats_pkey on seats s  (cost=0.28..64.60 rows=1339 width=7) (actual time=0.016..4.817 rows=1339 loops=1)
              Heap Fetches: 1339
        ->  Sort  (cost=259788.68..259893.54 rows=41947 width=10) (actual time=1352.000..7194.866 rows=110338003 loops=1)
              Sort Key: f.aircraft_code
              Sort Method: external sort  Disk: 16704kB
              ->  Nested Loop  (cost=0.43..256567.93 rows=41947 width=10) (actual time=0.055..1189.810 rows=700759 loops=1)
                    ->  Seq Scan on flights f  (cost=0.00..6921.34 rows=1074 width=8) (actual time=0.037..34.856 rows=17360 loops=1)
                          Filter: ((date(scheduled_departure) >= '2017-01-26'::date) AND (date(scheduled_departure) <= '2017-02-26'::date))
                          Rows Removed by Filter: 197507
                    ->  Index Scan using q4_tf_fid on ticket_flights tf  (cost=0.43..231.39 rows=106 width=10) (actual time=0.002..0.063 rows=40 loops=17360)
                          Index Cond: (flight_id = f.flight_id)
Planning Time: 0.384 ms
JIT:
  Functions: 16
  Options: Inlining false, Optimization false, Expressions true, Deforming true
  Timing: Generation 0.627 ms, Inlining 0.000 ms, Optimization 0.296 ms, Emission 6.305 ms, Total 7.228 ms
Execution Time: 27414.836 ms


## P5: B+ index (flight_id) en la tabla ticket_flights
###    B+ index (aircraft_code, scheduled_departure) en la tabla flights
GroupAggregate  (cost=258664.98..331517.72 rows=3688 width=39) (actual time=1344.383..27502.113 rows=1199 loops=1)
  Group Key: f.aircraft_code, s.seat_no
  ->  Merge Join  (cost=258664.98..307225.43 rows=3232826 width=13) (actual time=1335.778..17634.845 rows=110338099 loops=1)
        Merge Cond: (s.aircraft_code = f.aircraft_code)
        ->  Index Only Scan using seats_pkey on seats s  (cost=0.28..64.60 rows=1339 width=7) (actual time=0.016..4.409 rows=1339 loops=1)
              Heap Fetches: 1339
        ->  Sort  (cost=258664.70..258769.57 rows=41947 width=10) (actual time=1329.765..7190.379 rows=110338003 loops=1)
              Sort Key: f.aircraft_code
              Sort Method: external sort  Disk: 16704kB
              ->  Nested Loop  (cost=0.43..255443.95 rows=41947 width=10) (actual time=0.063..1165.526 rows=700759 loops=1)
                    ->  Seq Scan on flights f  (cost=0.00..6921.34 rows=1074 width=8) (actual time=0.043..34.230 rows=17360 loops=1)
                          Filter: ((date(scheduled_departure) >= '2017-01-26'::date) AND (date(scheduled_departure) <= '2017-02-26'::date))
                          Rows Removed by Filter: 197507
                    ->  Index Scan using q4_tf_fid on ticket_flights tf  (cost=0.43..230.36 rows=104 width=10) (actual time=0.002..0.061 rows=40 loops=17360)
                          Index Cond: (flight_id = f.flight_id)
Planning Time: 0.665 ms
JIT:
  Functions: 16
  Options: Inlining false, Optimization false, Expressions true, Deforming true
  Timing: Generation 0.641 ms, Inlining 0.000 ms, Optimization 0.283 ms, Emission 5.715 ms, Total 6.639 ms
Execution Time: 27504.485 ms

## P6: B+ index (flight_id) en la tabla ticket_flights
